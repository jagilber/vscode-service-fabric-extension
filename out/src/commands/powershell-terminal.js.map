{"version":3,"file":"powershell-terminal.js","sourceRoot":"","sources":["../../../src/commands/powershell-terminal.ts"],"names":[],"mappings":"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","sourcesContent":["import * as vscode from \"vscode\";\r\nimport * as vars from './osdetector';\r\nconst exec = require('child_process').exec;\r\nconst fs = require(\"fs\");\r\nconst path = require('path');\r\nconst os = require('os');\r\nconst eventEmitter = require('events');\r\nconst emitter = new eventEmitter();\r\n\r\nexport class powershellTerminal {\r\n\r\n    terminal: vscode.Terminal = null;\r\n    fileWatcher: vscode.FileSystemWatcher = null;\r\n    static tempDir: string = null;\r\n    tempFile: string = null;\r\n    writeEmitter = new vscode.EventEmitter<vscode.Uri>();\r\n    static requestCounter: number = 0;\r\n\r\n    constructor() {\r\n    }\r\n\r\n    private async addFileWatcher(): Promise<undefined> {\r\n        return await new Promise((resolve, reject) => {\r\n            fs.watch(powershellTerminal.tempDir, (eventType, filename) => {\r\n                this.consoleLog(`event type is: ${eventType}`);\r\n                if (filename) {\r\n                    this.consoleLog(`filename provided: ${filename}`);\r\n                } else {\r\n                    this.consoleLog('filename not provided');\r\n                }\r\n                emitter.emit(eventType, filename);\r\n            });\r\n            resolve(undefined);\r\n        });\r\n    }\r\n\r\n    private consoleLog(data:string){\r\n        console.log(new Date().toUTCString() + ':' + data);\r\n    }\r\n\r\n    private createTerminal(terminalName: string): boolean {\r\n        if (vscode.window.terminals.find(x => x.name === terminalName)) {\r\n            this.consoleLog(`found existing terminal ${terminalName}`);\r\n            this.terminal = vscode.window.terminals.find(x => x.name === terminalName);\r\n        }\r\n        else {\r\n            this.terminal = vscode.window.createTerminal(terminalName);\r\n\r\n            if (vars._isLinux || vars._isMacintosh) {\r\n                exec('sfctl cluster select --endpoint', function (err, stdout, stderr) {\r\n                    if (err) {\r\n                        vscode.window.showErrorMessage(\"Could not connect to cluster.\");\r\n                        this.consoleLog(err);\r\n                        return;\r\n                    }\r\n                });\r\n            }\r\n            else if (vars._isWindows) {\r\n                this.send(this.outFunctionGenerator(), false);\r\n                this.send('$PSModuleAutoLoadingPreference = 2', false);\r\n                this.show();\r\n            }\r\n        }\r\n        return this.terminal === null;\r\n    }\r\n\r\n    async deleteJsonFile(jsonFile: string): Promise<unknown> {\r\n        return await new Promise((resolve, reject) => {\r\n            if (fs.existsSync(jsonFile)) {\r\n                this.consoleLog(`removing jsonFile: ${jsonFile}`);\r\n                fs.unlinkSync(jsonFile);\r\n                this.consoleLog(`removed jsonFile: ${jsonFile}`);\r\n            }\r\n            resolve(jsonFile);\r\n        });\r\n    }\r\n\r\n    async disposeTerminal(): Promise<unknown> {\r\n        return await new Promise((resolve, reject) => {\r\n            if (this.terminal !== null) {\r\n                this.consoleLog('disposing terminal');\r\n                this.terminal.dispose();\r\n            }\r\n\r\n            if (powershellTerminal.tempDir !== null) {\r\n                this.consoleLog(`removing temp dir: ${powershellTerminal.tempDir}`);\r\n                fs.rmdirSync(powershellTerminal.tempDir, {\r\n                    maxRetries: 3,\r\n                    recursive: true,\r\n                    retryDelay: 1000\r\n                });\r\n                this.consoleLog(`removed temp dir: ${powershellTerminal.tempDir}`);\r\n            }\r\n            resolve(undefined);\r\n        });\r\n    }\r\n\r\n    hide(): void {\r\n        this.terminal.hide();\r\n    }\r\n\r\n    async initialize(terminalName: string): Promise<unknown> {\r\n        return await new Promise(async (resolve, reject) => {\r\n            if (powershellTerminal.tempDir === null) {\r\n                fs.mkdtemp(path.join(os.tmpdir(), 'pst-'), async (err, directory) => {\r\n                    if (err) {\r\n                        throw err;\r\n                    }\r\n\r\n                    this.consoleLog(directory);\r\n                    powershellTerminal.tempDir = directory.replace(/\\\\/g, '/');\r\n\r\n                    this.createTerminal(terminalName);\r\n                    await this.send(`write-host \"using: ${powershellTerminal.tempDir}\"`, false);\r\n                    await this.addFileWatcher();\r\n                    resolve(undefined);\r\n                });\r\n            }\r\n            else {\r\n                this.createTerminal(terminalName);\r\n                await this.addFileWatcher();\r\n                resolve(undefined);\r\n            }\r\n        });\r\n    }\r\n\r\n    private outFunctionGenerator(): string {\r\n        return '$global:requestCounter = 0;\\\r\n            function out-json{\\\r\n                [CmdletBinding()]\\\r\n                Param(\\\r\n                    [Parameter(ValueFromPipeline)]\\\r\n                    [string]$item,\\\r\n                    [string]$fileDir = \"' + powershellTerminal.tempDir + '\",\\\r\n                    [int]$depth = 2,\\\r\n                    [int]$counter = 0\\\r\n                )\\\r\n                if($counter -eq 0){\\\r\n                    $counter = ++$global:requestCounter;\\\r\n                }\\\r\n                else{\\\r\n                    $global:requestCounter = $counter;\\\r\n                }\\\r\n                $fileName = $fileDir + \"\\\\\" + $counter + \".json\";\\\r\n                $errorActionPreference = \"continue\";\\\r\n                write-host \"$item\";\\\r\n                try {\\\r\n                    $r = iex $item;\\\r\n                    write-host ($r | format-list * | out-string);\\\r\n                    $r | convertto-json -depth $depth -warningaction silentlycontinue | out-file \"$fileName\";\\\r\n                }\\\r\n                catch {\\\r\n                    write-error ($error | format-list * | out-string);\\\r\n                    $error | convertto-json -depth $depth -warningaction silentlycontinue | out-file \"$fileName\";\\\r\n                }\\\r\n            }\\\r\n            cls';\r\n    }\r\n\r\n    async readJson(jsonFile: string, nullOk: boolean = true): Promise<JSON> {\r\n        return await new Promise(async (resolve, reject) => {\r\n            await fs.readFile(jsonFile, 'utf8', (err, jsonString: string) => {\r\n                if (err) {\r\n                    this.consoleLog(`json read failed: ${err}`);\r\n                    reject();\r\n                }\r\n                this.consoleLog(`json data:\\r\\n${jsonString}`);\r\n                if (jsonString.length < 2) {\r\n                    this.consoleLog(`json read failed: empty file: ${jsonString}`);\r\n                    if (nullOk) {\r\n                        resolve(JSON);\r\n                    }\r\n                    else {\r\n                        reject(jsonString);\r\n                    }\r\n                }\r\n                resolve(JSON.parse(jsonString));\r\n            });\r\n        });\r\n    }\r\n\r\n    async readText(textFile: string): Promise<string> {\r\n        return await new Promise(async (resolve, reject) => {\r\n            await fs.readFile(textFile, 'utf8', (err, textString) => {\r\n                if (err) {\r\n                    this.consoleLog(`text read failed: ${err}`);\r\n                    reject();\r\n                }\r\n                this.consoleLog(`text data: ${textString}`);\r\n                resolve(textString);\r\n            });\r\n        });\r\n    }\r\n\r\n    async receive(outputFile: string): Promise<string> {\r\n        return await new Promise(async (resolve, reject) => {\r\n            await this.waitForEvent(emitter, outputFile);\r\n            this.consoleLog('receive returning');\r\n            resolve(outputFile);\r\n        });\r\n    }\r\n\r\n    async sendReceive(terminalCommand: string, checkForErrors: boolean = true): Promise<JSON> {\r\n        return await new Promise(async (resolve, reject) => {\r\n            var resultJson: JSON = await this.readJson(await this.send(terminalCommand, true));\r\n            if (checkForErrors) {\r\n                for (var key in resultJson) {\r\n                    this.consoleLog(`checking key: ${key}`);\r\n                    if (resultJson[key].hasOwnProperty('Exception')) {\r\n                        reject(resultJson);\r\n                    }\r\n                }\r\n            }\r\n            resolve(resultJson);\r\n        });\r\n    }\r\n\r\n    async sendReceiveText(terminalCommand: string, checkForErrors: boolean = true): Promise<string> {\r\n        return await new Promise(async (resolve, reject) => {\r\n            var resultText: string = await this.readText(await this.send(terminalCommand, true));\r\n            if (checkForErrors) {\r\n                if (resultText.startsWith('Exception') || resultText.startsWith('Error')) {\r\n                    reject(resultText);\r\n                }\r\n            }\r\n            resolve(resultText);\r\n        });\r\n    }\r\n\r\n    async send(terminalCommand: string, wait: boolean = true): Promise<string> {\r\n        return await new Promise(async (resolve, reject) => {\r\n            var fileName: string = powershellTerminal.tempDir + '/' + ++powershellTerminal.requestCounter + '.json';\r\n\r\n            if (wait) {\r\n                terminalCommand = '\"' + terminalCommand + '\" | out-json -counter ' + powershellTerminal.requestCounter + ';\\r\\n';\r\n            }\r\n            else {\r\n                terminalCommand += ';\\r\\n';\r\n            }\r\n\r\n            this.consoleLog(terminalCommand);\r\n            this.terminal.sendText(terminalCommand);\r\n\r\n            if (wait) {\r\n                await this.waitForEvent(emitter, fileName);\r\n            }\r\n\r\n            resolve(fileName);\r\n        });\r\n    }\r\n\r\n    sendText(terminalCommand: string): void {\r\n        var promise: Promise<string> = new Promise(async (resolve, reject) => {\r\n            await this.send(terminalCommand, true);\r\n            resolve(undefined);\r\n        });\r\n    }\r\n\r\n    show(): void {\r\n        this.terminal.show();\r\n    }\r\n\r\n    async waitForEvent<T>(emitter: NodeJS.EventEmitter, pendingFileName: string): Promise<unknown> {\r\n        this.consoleLog(`waitForEvent waiting for: ${pendingFileName}`);\r\n        return await new Promise(async (resolve, reject) => {\r\n            emitter.on('rename', async (fileName) => {\r\n                this.consoleLog(`waitForEvent rename emitter: ${fileName}`);\r\n                if (pendingFileName.endsWith('/' + fileName)) {\r\n                    // to handle null/no output as rename is always first event\r\n                    await new Promise<boolean>((res) => \r\n                        setTimeout(() => \r\n                            res(emitter.emit('change', fileName)), 1000));\r\n                    this.consoleLog(`waitForEvent rename emitted: ${pendingFileName}`);\r\n                    emitter.removeAllListeners();\r\n                    resolve(pendingFileName);\r\n                }\r\n            });\r\n            emitter.on('change', (fileName) => {\r\n                this.consoleLog(`waitForEvent change emitter: ${fileName}`);\r\n                if (pendingFileName.endsWith('/' + fileName)) {\r\n                    this.consoleLog(`waitForEvent change emitted: ${pendingFileName}`);\r\n                    emitter.removeAllListeners();\r\n                    resolve(pendingFileName);\r\n                }\r\n            });\r\n            emitter.on('error', (fileName) => {\r\n                if (pendingFileName.endsWith('/' + fileName)) {\r\n                    console.error(`waitForEvent error emitter: ${fileName}`);\r\n                    emitter.removeAllListeners();\r\n                    reject(fileName);\r\n                }\r\n            });\r\n        });\r\n    }\r\n}"]}