{"version":3,"file":"powershell-terminal.js","sourceRoot":"","sources":["../../../src/commands/powershell-terminal.ts"],"names":[],"mappings":"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","sourcesContent":["import { FSWatcher } from \"fs\";\r\nimport * as vscode from \"vscode\";\r\nimport * as vars from './osdetector';\r\nconst exec = require('child_process').exec;\r\nconst fs = require(\"fs\");\r\nconst path = require('path');\r\nconst os = require('os');\r\nconst eventEmitter = require('events');\r\nconst emitter = new eventEmitter();\r\n\r\nexport class powershellTerminal {\r\n\r\n    terminal: vscode.Terminal = null;\r\n    fileWatcher: vscode.FileSystemWatcher = null;\r\n    static tempDir: string = null;\r\n    tempFile: string = null\r\n    writeEmitter = new vscode.EventEmitter<vscode.Uri>();\r\n    requestCounter: number = 0;\r\n\r\n    constructor(terminalName: string) {\r\n        if (powershellTerminal.tempDir === null) {\r\n            fs.mkdtemp(path.join(os.tmpdir(), 'pst-'), (err, directory) => {\r\n                if (err) {\r\n                    throw err;\r\n                }\r\n                console.log(directory);\r\n                powershellTerminal.tempDir = directory.replace(/\\\\/g, '/');\r\n\r\n                fs.watch(powershellTerminal.tempDir, (eventType, filename) => {\r\n                    console.log(`event type is: ${eventType}`);\r\n                    if (filename) {\r\n                        console.log(`filename provided: ${filename}`);\r\n                    } else {\r\n                        console.log('filename not provided');\r\n                    }\r\n                    emitter.emit('change',filename);\r\n                });\r\n\r\n            });\r\n        }\r\n\r\n        this.createTerminal(terminalName);\r\n    }\r\n\r\n    async waitForEvent<T>(emitter: NodeJS.EventEmitter, pendingFileName:string): Promise<unknown> {\r\n        //waitForEvent<T>(emitter, event) {\r\n        return await new Promise((resolve, reject) => {\r\n            emitter.once('change', (fileName) => {\r\n                //console.log(emitter);\r\n                if(pendingFileName.endsWith(fileName)){\r\n                    console.log(pendingFileName);\r\n                    resolve(pendingFileName);\r\n                }\r\n            });\r\n            emitter.once('error', (event) => {\r\n                console.error(event);\r\n                reject(event);\r\n            });\r\n        });\r\n    }\r\n\r\n    async send(terminalCommand: string, wait: boolean = true): Promise<string> {\r\n        //send(terminalCommand: string, wait: boolean = true): Promise<string> {\r\n        //send(terminalCommand: string, wait: boolean = true): string {\r\n        return await new Promise(async (resolve,reject) => {\r\n            //var promise: Promise<string> = new Promise(() => {\r\n            var fileName: string = powershellTerminal.tempDir + '/' + ++this.requestCounter + '.json';\r\n            terminalCommand += ' | convertto-json | out-file ' + fileName + '\\r\\n';\r\n\r\n            this.terminal.sendText(terminalCommand);\r\n\r\n            if (wait) {\r\n               await this.waitForEvent(emitter, fileName);\r\n            }\r\n            resolve(fileName);\r\n        });\r\n    }\r\n\r\n    async readJson(jsonFile: string): Promise<string> {\r\n        return await new Promise((resolve,reject) => {\r\n            fs.readFile(jsonFile, 'utf8', (err, jsonString) => {\r\n                if (err) {\r\n                    console.log(\"File read failed:\", err);\r\n                    reject();\r\n                }\r\n                console.log('File data:', jsonString);\r\n                resolve(jsonString);\r\n            });\r\n        });\r\n    }\r\n\r\n    async receive(jsonFile: string): Promise<string> {\r\n        return await new Promise(async (resolve,reject) => {\r\n            await this.waitForEvent(emitter, jsonFile);\r\n            console.log('receive returning');\r\n            resolve(jsonFile);\r\n        });\r\n        //  });\r\n    }\r\n\r\n    createTerminal(terminalName: string): boolean {\r\n        if (vscode.window.terminals.find(x => x.name === terminalName)) {\r\n            console.log(`found existing terminal ${terminalName}`);\r\n            this.terminal = vscode.window.terminals.find(x => x.name === terminalName);\r\n        }\r\n        else {\r\n            this.terminal = vscode.window.createTerminal(terminalName);\r\n        }\r\n\r\n        if (vars._isLinux || vars._isMacintosh) {\r\n            exec('sfctl cluster select --endpoint', function (err, stdout, stderr) {\r\n                if (err) {\r\n                    vscode.window.showErrorMessage(\"Could not connect to cluster.\");\r\n                    console.log(err);\r\n                    return;\r\n                }\r\n            });\r\n        }\r\n        else if (vars._isWindows) {\r\n            this.terminal.show();\r\n            //   this.readJson(this.send('start-transcript ' + this.tempFile));\r\n        }\r\n\r\n        if (this.terminal === null) {\r\n            return false;\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    waitForObject(objectParam): boolean {\r\n        while (objectParam === null) {\r\n            console.log(objectParam === null);\r\n            setTimeout(this.waitForObject, 1000, objectParam);\r\n        }\r\n\r\n        return true;\r\n    }\r\n    async disposeTerminal() {\r\n        if (this.terminal !== null) {\r\n            await this.send(\"stop-transcript\");\r\n        }\r\n    }\r\n\r\n}"]}