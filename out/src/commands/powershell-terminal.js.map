{"version":3,"file":"powershell-terminal.js","sourceRoot":"","sources":["../../../src/commands/powershell-terminal.ts"],"names":[],"mappings":"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","sourcesContent":["import { FSWatcher } from \"fs\";\r\nimport { runInThisContext } from \"vm\";\r\nimport * as vscode from \"vscode\";\r\nimport * as vars from './osdetector';\r\nconst exec = require('child_process').exec;\r\nconst fs = require(\"fs\");\r\nconst path = require('path');\r\nconst os = require('os');\r\nconst eventEmitter = require('events');\r\nconst emitter = new eventEmitter();\r\n\r\nexport class powershellTerminal {\r\n\r\n    terminal: vscode.Terminal = null;\r\n    fileWatcher: vscode.FileSystemWatcher = null;\r\n    static tempDir: string = null;\r\n    tempFile: string = null\r\n    writeEmitter = new vscode.EventEmitter<vscode.Uri>();\r\n    requestCounter: number = 0;\r\n\r\n    constructor() {\r\n        //   this.initialize();\r\n    }\r\n\r\n    async initialize(terminalName: string) {\r\n        return await new Promise((resolve, reject) => {\r\n\r\n            if (powershellTerminal.tempDir === null) {\r\n                fs.mkdtemp(path.join(os.tmpdir(), 'pst-'), (err, directory) => {\r\n                    if (err) {\r\n                        throw err;\r\n                    }\r\n                    console.log(directory);\r\n                    powershellTerminal.tempDir = directory.replace(/\\\\/g, '/');\r\n                    this.createTerminal(terminalName);\r\n                    this.send(this.outFunctionGenerator(), false);\r\n\r\n                    fs.watch(powershellTerminal.tempDir, (eventType, filename) => {\r\n                        console.log(`event type is: ${eventType}`);\r\n                        if (filename) {\r\n                            console.log(`filename provided: ${filename}`);\r\n                        } else {\r\n                            console.log('filename not provided');\r\n                        }\r\n                        emitter.emit('change', filename);\r\n                    });\r\n\r\n                    resolve(undefined);\r\n                });\r\n            }\r\n        });\r\n    }\r\n\r\n    outFunctionGenerator(){\r\n        return '$global:requestCounter = 0;\\\r\n            function out-json{\\\r\n                [CmdletBinding()]\\\r\n                Param(\\\r\n                    [Parameter(ValueFromPipeline)]\\\r\n                    [string]$item,\\\r\n                    [string]$fileDir = \"' + powershellTerminal.tempDir +'\",\\\r\n                    [int]$depth = 1,\\\r\n                    [int]$counter = 0\\\r\n                )\\\r\n                if($counter -eq 0){\\\r\n                    $counter = ++$global:requestCounter;\\\r\n                }\\\r\n                $fileName = $fileDir + \"\\\\\" + $counter + \".json\";\\\r\n                $errorActionPreference = \"continue\";\\\r\n                write-host \"$item\";\\\r\n                $r = . $item;\\\r\n                write-host ($r| fl * | out-string);\\\r\n                $r | convertto-json -depth $depth | out-file \"$fileName\";\\\r\n            }';\r\n    }\r\n\r\n    async waitForEvent<T>(emitter: NodeJS.EventEmitter, pendingFileName: string): Promise<unknown> {\r\n\r\n        return await new Promise((resolve, reject) => {\r\n            emitter.once('change', (fileName) => {\r\n                //console.log(emitter);\r\n                if (pendingFileName.endsWith(fileName)) {\r\n                    console.log(pendingFileName);\r\n                    resolve(pendingFileName);\r\n                }\r\n            });\r\n            emitter.once('error', (event) => {\r\n                console.error(event);\r\n                reject(event);\r\n            });\r\n        });\r\n    }\r\n\r\n    async send(terminalCommand: string, wait: boolean = true): Promise<string> {\r\n        return await new Promise(async (resolve, reject) => {\r\n            var fileName: string = powershellTerminal.tempDir + '/' + ++this.requestCounter + '.json';\r\n            //terminalCommand += ' | convertto-json | out-file ' + fileName + '\\r\\n';\r\n            if(wait){\r\n                //terminalCommand += ' | out-json(\"' + fileName + '\")\\r\\n';\r\n                //terminalCommand = 'out-json -item \"'+ terminalCommand +'\" -filename \"' + fileName + '\";\\r\\n';\r\n                terminalCommand = '\"' + terminalCommand + '\" | out-json -counter ' + this.requestCounter + ';\\r\\n';\r\n            }\r\n            else{\r\n                terminalCommand += ';\\r\\n';\r\n            }\r\n            \r\n            console.log(terminalCommand);\r\n            this.terminal.sendText(terminalCommand);\r\n\r\n            if (wait) {\r\n                await this.waitForEvent(emitter, fileName);\r\n            }\r\n\r\n            resolve(fileName);\r\n        });\r\n    }\r\n\r\n    async readJson(jsonFile: string): Promise<string> {\r\n        return await new Promise((resolve, reject) => {\r\n            fs.readFile(jsonFile, 'utf8', (err, jsonString) => {\r\n                if (err) {\r\n                    console.log(\"File read failed:\", err);\r\n                    reject();\r\n                }\r\n                console.log('File data:', jsonString);\r\n                resolve(jsonString);\r\n            });\r\n        });\r\n    }\r\n\r\n    async receive(jsonFile: string): Promise<string> {\r\n        return await new Promise(async (resolve, reject) => {\r\n            await this.waitForEvent(emitter, jsonFile);\r\n            console.log('receive returning');\r\n            resolve(jsonFile);\r\n        });\r\n        //  });\r\n    }\r\n\r\n    createTerminal(terminalName: string): boolean {\r\n        if (vscode.window.terminals.find(x => x.name === terminalName)) {\r\n            console.log(`found existing terminal ${terminalName}`);\r\n            this.terminal = vscode.window.terminals.find(x => x.name === terminalName);\r\n        }\r\n        else {\r\n            this.terminal = vscode.window.createTerminal(terminalName);\r\n        }\r\n\r\n        if (vars._isLinux || vars._isMacintosh) {\r\n            exec('sfctl cluster select --endpoint', function (err, stdout, stderr) {\r\n                if (err) {\r\n                    vscode.window.showErrorMessage(\"Could not connect to cluster.\");\r\n                    console.log(err);\r\n                    return;\r\n                }\r\n            });\r\n        }\r\n        else if (vars._isWindows) {\r\n            this.terminal.show();\r\n            //   this.readJson(this.send('start-transcript ' + this.tempFile));\r\n        }\r\n\r\n        if (this.terminal === null) {\r\n            return false;\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    waitForObject(objectParam): boolean {\r\n        while (objectParam === null) {\r\n            console.log(objectParam === null);\r\n            setTimeout(this.waitForObject, 1000, objectParam);\r\n        }\r\n\r\n        return true;\r\n    }\r\n    async disposeTerminal() {\r\n        if (this.terminal !== null) {\r\n            await this.send(\"stop-transcript\");\r\n        }\r\n    }\r\n\r\n}"]}